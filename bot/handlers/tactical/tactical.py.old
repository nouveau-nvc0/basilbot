from aiogram import Dispatcher, Bot
from aiogram.types import Message, BufferedInputFile
from wand.image import Image

from bot.command_filter import CommandFilter

import os


class TacticalHandler:
    aliases = ["боевая", "бой"]
    bot: Bot

    bubbles_aliases = ["справа", "слева", "центр"]
    bubbles: list[Image]

    bubble_height_default = 260

    def __init__(self, dp: Dispatcher, bot: Bot, static_path: str) -> None:
        self.bot = bot

        self.bubbles = []
        for i in range(len(self.bubbles_aliases)):
            self.bubbles.append(Image(filename=os.path.join(
                static_path, "tactical", f"speech-bubble{i}.png")))

        dp.message(CommandFilter(self.aliases))(self.handle)

    async def handle(self, message: Message, args: list[str]) -> any:
        if not message.photo:
            await message.answer("нужно прикрепить пикчу")
            return

        variant = 0
        if len(args) > 0:
            if not args[0] in self.bubbles_aliases:
                await message.answer("неизвестный вариант диалогового облачка")
                return
            variant = self.bubbles_aliases.index(args[0])

        for x in message.photo:
            pic = await self.bot.download(message.photo[-1])

            with Image(blob=pic) as source:
                source_width, source_height = source.size

                bubble = self.bubbles[variant].clone()
                bubble_width, bubble_height = bubble.size
                ratio = source_width / bubble_width
                bubble_height = int(bubble_height * ratio)
                bubble.resize(source_width, bubble_height)

                source.extent(source_width, int(
                    source_height+int(self.bubble_height_default * ratio)),
                    0, int(self.bubble_height_default * ratio) * -1)

                source.composite(bubble)

                blob = source.make_blob("jpeg")
                await message.answer_photo(BufferedInputFile(blob, "default"),
                                           "ваша пикча")
            break  # dirty hack, eliminate asap
